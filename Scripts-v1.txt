________________ TO CONNECT TO MYSQL DATABASE ________________
mysql -h localhost -u training -p training
use training;

-- create table
CREATE TABLE transactions(id varchar(20),chain varchar(20), dept varchar(20),category varchar(20), company varchar(20), 
brand varchar(20), date1 varchar(10), productsize int, productmeasure varchar(10), purchasequantity int, purchaseamount FLOAT);

-- load data
LOAD DATA INFILE '/home/cloudera/Desktop/transactions.csv' INTO TABLE transactions
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\r\n';


________________SQOOP________________________________________________
#### SQOOP data into HDFS##########

Sqoop import –connect jdbc:mysql://localhost/training –username training –P –table transactions –m 1 –target-dir /InputFiles/HiveExternal/Transaction_Staging



_______________PIG SCRIPTS__________________________________________



transactions = LOAD '/InputFiles/HiveExternal/Transaction_Staging/part-m-00000' USING PigStorage(',') as (id:chararray,chain:chararray,dept:chararray,category:chararray,company:chararray,brand:chararray,date:chararray, productsize:float, productmeasure:chararray, purchasequantity:int, purchaseamount:float);
-- ### grouping
custGroup = GROUP transactions BY id; 
-- ### sum operation
custSpendings = FOREACH custGroup GENERATE group, SUM(transactions.purchaseamount) as spendings; 
custSpendingsSort = ORDER custSpendings BY spendings desc;
top10Cust = LIMIT custSpendingsSort 10;

STORE top10Cust INTO ‘/OutputFolder/Pig/top10Cust’ 

--- #### Chain wise sales ########### --------------------

chainGroup = GROUP transactions BY chain;
chainSales = FOREACH chainGroup GENERATE group, SUM(transactions.purchasequantity) as totalQuantity, SUM(transactions.purchaseamount) as totalSales;
STORE chainSales INTO 'chainSales‘;
-- ##### Each chain, top 10 customers ######## ---------------

chainGroupCust = GROUP transactions BY (chain,id);
chainGroupCustSpedings1 = FOREACH chainGroupCust GENERATE group, SUM(transactions.purchaseamount) as spendings;
chainGroupCustSpendings2= FOREACH chainGroupCustSpedings1 generate group.chain as chain,group.id as id, spendings;
chainGroupCustSpendings3= GROUP chainGroupCustSpendings2 BY chain;
chainTop10Cust = FOREACH chainGroupCustSpendings3{			  chainGroupCustSpedingsSort = ORDER chainGroupCustSpendings2 BY spendings DESC;
top10Cust = LIMIT chainGroupCustSpedingsSort  10;			
GENERATE top10Cust;			
chainTop10Cust = FOREACH chainTop10Cust GENERATE FLATTEN(top10Cust);
STORE chainTop10Cust INTO ‘chainTop10Cust ’
--- #### Each customer most bought brand ###### ----------
 CustBrandGroup = GROUP transactions BY (id,brand);
CustBrandQuantity = FOREACH CustBrandGroup GENERATE group, SUM(transactions.purchasequantity) as sales;
CustBrandQuantity = FOREACH CustBrandQuantity GENERATE group.brand as brand, group.id as id,  sales;
CustBrandQuantityGroup = GROUP CustBrandQuantity BY brand;
custTop5Brands = FOREACH CustBrandQuantityGroup{ CustBrandQuantityGroupSort = ORDER CustBrandQuantity BY sales DESC;
top5Brand = LIMIT CustBrandQuantityGroupSort  5;
GENERATE top5Brand;
---------------------------------------------------------------



(^_^)________HIVE SCRIPTS ________________(^_^)________

#### Sqoop data from mysql to hive

sqoop import --connect jdbc:mysql://localhost/training \
   --username training -P \
   --table transactions \
   --hive-import \
   --hive-table transactions_staging -m 1 ;

############### Properties for Partitioning and bucketing###########################

set hive.enforce.bucketing = true;
set hive.exec.dynamic.partition = true;
set hive.exec.dynamic.partition.mode = nonstrict;


######## Create production table #######################################################

CREATE TABLE transactions_production
( id string,
dept string,
category string,
company string,
brand string,
date1 string,
productsize int,
productmeasure string,
purchasequantity int,
purchaseamount double)
PARTITIONED BY (chain   string) CLUSTERED BY(id) INTO 5 BUCKETS
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

INSERT OVERWRITE TABLE transactions_production PARTITION (chain) 
select id,dept, category, company,brand,date1,productsize,productmeasure,
purchasequantity,purchaseamount,chain from transactions_staging;

############ Top 10 Results ######################

select id, sum(purchaseamount) as custSpendings from transactions_production
group by id
sort by custSpendings DESC
limit 10;

############## Chain wise sales ##################

select chain, sum(purchaseamount), sum(purchasequantity) from transactions_production
group by chain;

############# Top 10 brands ###############
select brand, sum(purchaseamount) as custSpendings from transactions_production
group by brand
sort by custSpendings DESC
limit 10;

####### -- top 10 companies ###############
select company, sum(purchaseamount) as custSpendings from transactions_production
group by company
sort by custSpendings DESC
limit 10;

##### -- Chain Year Monthly Sales ################
select chain, split(date1,'/')[2] as year1, split(date1,'/')[0] as month1, 
sum(purchaseamount) as totalsales from transactions_production
group by chain,split(date1,'/')[0],split(date1,'/')[2];

##### CREATE TABLE top10companies 
AS
select company, sum(purchaseamount) as custSpendings from transactions_production
group by company
sort by custSpendings DESC





